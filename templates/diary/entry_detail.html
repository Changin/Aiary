<!--- 상세 보기 + 채팅 페이지 --->
{% extends "base.html" %}
{% block title %}일기 상세 | Aiary{% endblock %}
{% block content %}
<div class="row g-4" style="font-family: 'Malgun Gothic', sans-serif;">
    <!-- 좌: 일기 내용 -->
    <div class="col-lg-7">
        <!-- 감정 분석 카드 -->
        <div class="card border-0 shadow-sm mb-4" style="
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08) !important;
            background-color: #fafaf8; /* 약간 밝은 배경 */
            border: 1px solid #e1f0f2;
        ">
            <div class="card-body" style="padding: 30px;">
                <h2 class="h6 mb-3" style="
                    color: #1a8a9a;
                    font-weight: 700;
                    font-size: 1.4rem;
                    border-bottom: 2px solid #e9ecef;
                    padding-bottom: 10px;
                ">오늘의 감정 리포트</h2>
                <div id="analysis-empty-block"
                     {% if object.summary or object.suggestions or object.emotion_vector.main_emotions %}
                     style="display:none;"
                     {% endif %}>
                    <p class="text-muted small mb-0" style="font-size: 0.9rem;">
                        아직 이 일기에 대한 분석 정보가 없습니다. 분석이 완료되면 자동으로 표시됩니다.
                    </p>
                </div>

                <div id="analysis-main-block"
                     {% if not object.summary and not object.suggestions and not object.emotion_vector.main_emotions %}
                     style="display:none;"
                     {% endif %}>
                    {% if object.summary %}
                    <div class="mb-3">
                        <div class="small text-muted mb-1" style="font-weight: 600; color: #6c757d !important;">요약</div>
                        <p id="analysis-summary" class="mb-0"
                           style="white-space: pre-wrap; font-size: 0.95rem; color: #343a40;">{{ object.summary }}</p>
                    </div>
                    {% else %}
                    <div class="mb-3">
                        <div class="small text-muted mb-1" style="font-weight: 600; color: #6c757d !important;">요약</div>
                        <p id="analysis-summary" class="mb-0"
                           style="white-space: pre-wrap; font-size: 0.95rem; color: #343a40;"></p>
                    </div>
                    {% endif %}

                    <div class="mb-3">
                        <div class="small text-muted mb-1" style="font-weight: 600; color: #6c757d !important;">두드러지는 감정</div>
                        <div id="analysis-emotions">
                            {% with emotions=object.emotion_vector.main_emotions %}
                                {% if emotions %}
                                    {% for emo in emotions %}
                                        <span class="badge me-1 mb-1" style="
                        background-color: #DCE1BB;
                        color: #586211;
                        font-size: 0.85rem;
                        font-weight: 600;
                        border-radius: 12px;
                        padding: 5px 10px;
                    ">{{ emo }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span class="text-muted small">분석 정보 없음</span>
                                {% endif %}
                            {% endwith %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="small text-muted mb-1" style="font-weight: 600; color: #6c757d !important;">자기 평가 기분
                            점수
                        </div>
                        <span id="analysis-mood">
                            {% if object.mood_self_report %}
                                <span class="badge" style="
                        background-color: #e9ecef;
                        color: #1a1a1a;
                        font-size: 0.9rem;
                        padding: 6px 10px;
                        border-radius: 15px;
                    ">
                                {{ object.mood_self_report }}/10
                                </span>
                            {% else %}
                                <span class="text-muted small" style="font-size: 0.85rem;">입력된 점수가 없습니다.</span>
                            {% endif %}
                        </span>
                    </div>

                    <div class="mt-3 p-3 rounded" style="background-color: #e9ecef; border: 1px dashed #ced4da;">
                        <div class="small text-muted mb-1" style="font-weight: 600; color: #1a8a9a !important;">오늘을 위한 작은 제안</div>
                        <p id="analysis-suggestions" class="mb-0"
                           style="white-space: pre-wrap; font-size: 0.95rem; color: #343a40;">{{ object.suggestions }}</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm" style="
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08) !important;
            background-color: #fafaf8;
        ">
            <div class="card-body" style="padding: 30px;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h2 class="h5 mb-0" style="
                        color: #333;
                        font-weight: 700;
                        font-size: 1.5rem;
                        ">{{ object.title|default:"(제목 없음)" }}</h2>
                    <small class="text-muted" style="
                        color: #888 !important;
                        font-size: 0.85rem;
                    ">{{ object.entry_date|date:"Y-m-d" }}</small>
                </div>
                <hr style="
                    margin-top: 10px;
                    margin-bottom: 20px;
                    border-color: #eee;
                ">
                <p class="mb-3" style="
                    white-space:pre-wrap;
                    font-size: 1.05rem;
                    line-height: 1.6;
                    color: #444;
                ">{{ object.content }}</p>

                <div class="d-flex gap-2" style="margin-top: 30px;">
                    <a href="{% url 'diary:list' %}" class="btn btn-outline-secondary btn-sm" style="
                        border-radius: 25px;
                        font-weight: 600;
                        padding: 8px 18px;
                        border-color: #1a8a9a;
                        color: #1a8a9a;
                    ">목록</a>
                    <a href="{% url 'diary:create' %}" class="btn btn-primary btn-sm" style="
                        border-radius: 25px;
                        font-weight: 600;
                        padding: 8px 18px;
                        background-color: #1a8a9a;
                        border-color: #1a8a9a;
                    ">새 일기</a>
                    <button type="button" class="btn btn-outline-secondary btn-sm" disabled style="
                        border-radius: 25px;
                        font-weight: bolder;
                        padding: 8px 18px;
                        border-color: #6E7B15;
                        color: #6E7B15;
                    ">
                        수정
                    </button>
                    <a href="{% url 'diary:delete' object.pk %}" class="btn btn-outline-danger btn-sm" style="
                        border-radius: 25px;
                        font-weight: 600;
                        padding: 8px 18px;
                        background-color: #dc3545;
                        border-color: #dc3545;
                        color: white;
                    ">
                        삭제
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-5">
        <div class="card border-0 shadow-sm" id="chatCard" data-session-id="{{ session.id }}" style="
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08) !important;
            background-color: #fafaf8;
            ">
            <div class="card-body d-flex flex-column" style="
                height: 750px; /* 채팅창 높이 조정 */
                padding: 30px;
                ">
                <h2 class="h6 mb-3" style="
                    font-weight: 700;
                    color: #1a8a9a;
                    border-bottom: 2px solid #e9ecef;
                    padding-bottom: 10px;
                    font-size: 1.25rem;
                    ">Aiary Chatbot</h2>

                <div class="mb-3">
                    <span class="badge" style="
                        background-color: #e9ecef;
                        border: 1px dashed #ced4da;
                        color: #6C7278;
                        font-size: 0.9rem;
                        padding: 6px 10px;
                        border-radius: 15px;
                        font-weight: 500;
                    ">
                        남은 무료 메시지: <span id="turnsRemaining">{{ turns_remaining }}</span> / {{ max_turns }}
                    </span>
                </div>

                <div id="chatLog" class="border rounded p-3 mb-3 flex-grow-1 overflow-auto bg-light small" style="
                    background-color: #e9ecef !important;
                    border: 1px dashed #ced4da;
                    border-radius: 16px !important;
                    border: none !important;
                    padding: 15px !important;
                    font-size: 0.95rem;
                    ">
                </div>

                {{ turns|json_script:"initial-turns-data" }}
                <script id="turn-info" type="application/json">
                    {
                        "max_turns": {{ max_turns|default:"null" }},
                        "turns_used": {{ turns_used|default:"0" }}
                    }
                </script>

                <form id="chatForm" class="d-flex gap-2">
                    {% csrf_token %}
                    <input id="chatInput" class="form-control" placeholder="메시지를 입력하세요..." autocomplete="off" style="
                        border-radius: 20px;
                        padding: 10px 15px;
                        font-size: 1rem;
                        border-color: #a7aaae;
                    ">
                    <button id="chatSendBtn" class="btn btn-primary" type="submit" style="
                        font-size: 0.9rem;
                        background-color: #1a8a9a;
                        border-color: #1a8a9a;
                        font-weight: 600;
                        border-radius: 20px;
                        padding: 10px 15px;
                        white-space: nowrap;
                    ">보내기
                    </button>
                </form>


                <!-- 턴 다 썼을 때 노출할 결제(더미) 버튼 -->
                <div id="upgradeWrapper" class="mt-2" style="display: none;">
                    <button id="upgradeBtn" class="btn w-100 btn-aiary-purchase" type="button" style="
                        border-radius: 20px;
                        font-weight: 600;
                        padding: 8px 15px;
                    ">
                        토큰 구매하고 상담 계속하기
                    </button>
                    <div class="small text-muted mt-1 text-center" style="
                        font-size: 0.75rem;
                        color: #6C7278 !important;
                    ">
                        * 현재는 결제 연동 전 상태이며, 데모용 버튼입니다.
                    </div>
                </div>

                <div id="chatStatus" class="small mt-2 text-muted" style="min-height: 1.2em; font-size: 0.85rem;"></div>

                <div id="chatHint" class="form-text mt-2" style="
                    font-size: 0.65rem;
                    color: #6C7278;
                    text-align: right;
                ">* Aiary 챗봇은 전문 상담사를 대체할 수 없습니다. (gpt-4.1-mini)
                </div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    const card = document.getElementById("chatCard");
    const sessionId = card.dataset.sessionId;
    const chatLog = document.getElementById("chatLog");
    const chatForm = document.getElementById("chatForm");
    const chatInput = document.getElementById("chatInput");
    const chatSendBtn = document.getElementById("chatSendBtn");
    const chatStatus = document.getElementById("chatStatus");
    const upgradeWrapper = document.getElementById("upgradeWrapper");
    const upgradeBtn = document.getElementById("upgradeBtn");
    const turnsRemainingSpan = document.getElementById("turnsRemaining");
    const analysisEmpty = document.getElementById("analysis-empty-block");
    const analysisMain = document.getElementById("analysis-main-block");
    const summaryEl = document.getElementById("analysis-summary");
    const emotionsEl = document.getElementById("analysis-emotions");
    const moodEl = document.getElementById("analysis-mood");
    const suggestionsEl = document.getElementById("analysis-suggestions");

    const initialTurns = JSON.parse(
        document.getElementById("initial-turns-data").textContent
    );

    const turnInfo = JSON.parse(
        document.getElementById("turn-info").textContent
    );

    let isLoading = false;
    let maxTurns = turnInfo.max_turns;
    let turnsUsed = turnInfo.turns_used;
    let pollingTimer = null;
    let lastTurnCount = initialTurns.length;


    function renderTurns(turns) {
        // console.log("renderTurns(), ", turns);
        if (!chatLog) {
            console.error("chatLog element not found");
            return;
        }
        if (!Array.isArray(turns)) {
            console.error("turns is not array", turns);
            return;
        }

        chatLog.innerHTML = "";
        turns.forEach(t => {
            if (!t || typeof t.message === "undefined") {
                console.warn("invalid turn object:", t);
                return;
            }
            const sender = (t.sender === "user") ? "user" : "assistant";
            appendBubble(t.sender, t.message);
        });
        lastTurnCount = turns.length;
    }

    function appendBubble(sender, text) {
        const wrap = document.createElement("div");
        wrap.className = sender === "user" ? "text-end mb-2" : "text-start mb-2";
        const b = document.createElement("div");
        b.className = "d-inline-block px-3 py-2";
        // 스타일 속성 직접 적용
        b.style.maxWidth = "85%";
        b.style.whiteSpace = "pre-wrap";
        b.style.fontSize = "0.95rem";
        b.textContent = text;

        if (sender === "user") {
            b.style.backgroundColor = "#1a8a9a"; // 사용자: 강조색 배경
            b.style.color = "white";
            b.style.border = "none";
            b.style.borderRadius = "15px 15px 0 15px"; // 우상단, 우하단, 좌하단, 좌상단 순서
        } else {
            b.style.backgroundColor = "#ffffff"; // 챗봇: 흰색 배경
            b.style.color = "#333";
            b.style.border = "1px solid #ced4da";
            b.style.borderRadius = "15px 15px 15px 0"; // 좌상단, 우상단, 우하단, 좌하단 순서
        }

        wrap.appendChild(b);
        chatLog.appendChild(wrap);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    // 감정분석카드 업데이트
    function updateAnalysisCard(analysis) {
        if (!analysis) return;

        const {
            summary,
            suggestions,
            emotions,
            mood
        } = analysis;

        // 아무 정보도 없으면 비워두기
        const hasAny =
            (summary && summary.trim() !== "") ||
            (suggestions && suggestions.trim() !== "") ||
            (Array.isArray(emotions) && emotions.length > 0);

        if (!hasAny) {
            if (analysisMain) analysisMain.style.display = "none";
            if (analysisEmpty) analysisEmpty.style.display = "block";
            return;
        }

        if (analysisEmpty) analysisEmpty.style.display = "none";
        if (analysisMain) analysisMain.style.display = "block";

        if (summaryEl) {
            summaryEl.textContent = summary || "";
            summaryEl.parentElement.style.display = summary ? "block" : "none";
        }

        if (emotionsEl) {
            emotionsEl.innerHTML = "";
            if (Array.isArray(emotions) && emotions.length > 0) {
                emotions.forEach(e => {
                    const span = document.createElement("span");
                    span.className = "badge me-1 mb-1";
                    span.style = "background-color: #DCE1BB;color: #586211;font-size: 0.85rem;font-weight: 600;border-radius: 12px;padding: 5px 10px;";
                    span.textContent = e;
                    emotionsEl.appendChild(span);
                });
            } else {
                const span = document.createElement("span");
                span.className = "text-muted small";
                span.textContent = "분석 정보 없음";
                emotionsEl.appendChild(span);
            }
        }

        if (moodEl) {
            if (mood != null) {
                moodEl.innerHTML =
                    '<span class="badge" style="background-color: #e9ecef;color: #1a1a1a;font-size: 0.9rem;padding: 6px 10px;border-radius: 15px;">' +
                    mood +
                    "/10</span>";
            } else {
                moodEl.innerHTML =
                    '<span class="text-muted small" style="font-size: 0.85rem;">입력된 점수가 없습니다.</span>';
            }
        }

        if (suggestionsEl) {
            suggestionsEl.textContent = suggestions || "";
        }
    }

    // 턴 정보 UI 업데이트
    function updateTurnUI() {
        if (turnsRemainingSpan) {
            if (maxTurns === null){
                // 무제한
                turnsRemainingSpan.textContent = "무제한";
            } else {
                const remaining = Math.max(0, maxTurns - turnsUsed);
                turnsRemainingSpan.textContent = remaining;
            }
        }

        // 입력창, 버튼, 업그레이드 버튼
        if (maxTurns === null) {
            // 무제한
            if (!isLoading) {
                chatInput.disabled = false;
                chatSendBtn.disabled = false;
            }
            if (upgradeWrapper) upgradeWrapper.style.display = "none";
            return;
        }

        if (turnsUsed >= maxTurns) {
            chatInput.disabled = true;
            chatSendBtn.disabled = true;
            upgradeWrapper.style.display = "block";
            if (!isLoading) {
                chatInput.placeholder = "무료 메시지 한도를 모두 사용했습니다.";
            }
        } else {
            if (!isLoading) {
                chatInput.disabled = false;
                chatSendBtn.disabled = false;
            }
            upgradeWrapper.style.display = "none";
        }
    }

    // 초기 턴 상태 반영
    updateTurnUI();

    function startPollingForNewTurns() {
        if (pollingTimer) return;

        chatStatus.textContent = "Aiary가 답변을 준비하고 있어요...";
        isLoading = true;
        chatInput.disabled = true;
        chatSendBtn.disabled = true;

        pollingTimer = setInterval(function() {
            fetch("{% url 'api:chat_history' %}?session_id=" + encodeURIComponent(sessionId), {
                    method: "GET",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest"
                    }
                })
                .then(resp => resp.json())
                .then(data => {
                    const turns = data.turns || [];
                    const analysis = data.analysis || null;

                    // 최신 턴 수 반영
                    if (typeof data.turns_used === "number") {
                        turnsUsed = data.turns_used;
                    }
                    if (typeof data.max_turns === "number" || data.max_turns === null) {
                        maxTurns = data.max_turns;
                    }
                    updateTurnUI();
                    updateAnalysisCard(analysis);

                    if (turns.length <= lastTurnCount) {
                        // 아직 새로운 턴이 없음
                        // console.log("retry polling..");
                        return;
                    }

                    // 2) 새로 추가된 턴들 중에 assistant 턴이 있는지 확인
                    const newTurns = turns.slice(lastTurnCount);  // 새로 생긴 턴들만
                    const hasNewAssistant = newTurns.some(
                        t => t && t.sender === "assistant"
                    );

                    // 2-1) 아직 assistant 턴이 없으면: 그냥 lastTurnCount만 갱신하고 계속 폴링
                    if (!hasNewAssistant) {
                        // console.log("retry polling..");
                        lastTurnCount = turns.length;
                        return;
                    }

                    renderTurns(turns);

                    clearInterval(pollingTimer);
                    pollingTimer = null;
                    isLoading = false;
                    updateTurnUI();
                    chatStatus.textContent = "";
                })
                .catch(err => {
                    console.error(err);
                    clearInterval(pollingTimer);
                    pollingTimer = null;
                    isLoading = false;
                    updateTurnUI();
                    chatStatus.textContent = "상담 내용을 가져오는 중 오류가 발생했습니다.";
                });
        }, 3000);
    }

    async function sendMessage(text) {
        appendBubble("user", text); // 프론트 미리 시각화
        chatInput.value = "";
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        isLoading = true;
        chatInput.disabled = true;
        chatSendBtn.disabled = true;
        chatStatus.textContent = "Aiary가 답변을 준비하고 있어요...";

        try {
            const resp = await fetch("{% url 'api:chat_send' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken,
                },
                body: JSON.stringify({
                    session_id: sessionId,
                    message: text
                })
            });
            const data = await resp.json();

            if (data.error === "turn_limit_reached") {
                turnsUsed = data.turns_used;
                maxTurns = data.max_turns;
                updateTurnUI();
                isLoading = false;
                // chatStatus.textContent = data.message || "무료 메시지 한도를 모두 사용했습니다.";
                chatInput.placeholder = data.message || "무료 메시지 한도를 모두 사용했습니다.";
                return;
            }

            // 정상: 큐에 넣었으니 폴링 시작
            if (typeof data.turns_used === "number") {
                turnsUsed = data.turns_used;
            }
            if (typeof data.max_turns === "number" || data.max_turns === null) {
                maxTurns = data.max_turns;
            }
            startPollingForNewTurns();
        } catch (e) {
            console.error(e);
            isLoading = false;
            chatStatus.textContent = "네트워크 오류로 인해 요청을 보내지 못했습니다.";
            updateTurnUI();
        }
    }

    chatForm.addEventListener("submit", function(e) {
        e.preventDefault();
        if (isLoading || (maxTurns !==null && turnsUsed >= maxTurns)) return;
        const text = chatInput.value.trim();
        if (!text) return;
        sendMessage(text);
    });

    // 페이지 최초 로딩 시: 턴이 없다면 최초 분석 폴링 시작
    if (initialTurns.length === 0) {
        appendBubble("assistant", "일기 내용을 분석하고 있어요. 잠시만 기다려 주세요...");
        chatInput.disabled = true;
        chatSendBtn.disabled = true;
        startPollingForNewTurns();
    } else {
        renderTurns(initialTurns);
    }

    // 더미 결제 버튼 클릭 시
    if (upgradeBtn) {
        upgradeBtn.addEventListener("click", function() {
            alert("현재는 데모 버전이며 실제 결제 기능은 제공되지 않습니다.");
        });
    }

})();
</script>
{% endblock %}
