<!--- 일기 작성 폼 --->
{% extends "base.html" %}
{% block title %}새 일기 | Aiary{% endblock %}
{% block content %}
<div class="row g-4" style="font-family: 'Malgun Gothic', sans-serif;">
    <!-- 좌: 일기 작성 -->
    <div class="col-lg-7">
        <div class="card border-0 shadow-sm" style="
                border-radius: 12px;
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1) !important;
                background-color: #fafaf8;
            ">
            <div class="card-body" style="
                    padding: 30px;
                ">
                <h2 class="h5 mb-3" style="
                        color: #1a1a1a;
                        font-weight: 700;
                        font-size: 1.5rem;
                        border-bottom: 2px solid #e9ecef;
                        padding-bottom: 10px;
                        margin-bottom: 25px !important;
                    ">오늘의 일기</h2>
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="date" class="form-label"
                               style="font-weight: 600; color: #1a1a1a; margin-bottom: 8px;">{{ form.entry_date.label_tag }}</label>
                        {{ form.entry_date }}
                    </div>
                    <div class="mb-3">
                        <label for="title" class="form-label"
                               style="font-weight: 600; color: #1a1a1a; margin-bottom: 8px;">제목:</label>
                        {{ form.title }}
                    </div>
                    <div class="mb-3">
                        <label for="id_image" class="form-label"
                               style="font-weight: 600; color: #1a1a1a; margin-bottom: 8px;">손글씨 일기 인식 (선택)</label>
                        <input type="file" name="image" id="id_image" accept="image/*"
                               class="form-control"
                               style="
                                    border-radius: 16px;
                                    padding: 10px 15px;
                                    font-size: 1rem;
                                    border: 1px solid #a7aaae;
                                    background-color: #fafaf8;
                                    /* 파일 선택 버튼 자체는 브라우저가 그리므로, 이 배경색은 입력 영역 전체에 적용됨 */
                                ">
                        <div class="form-text">
                            사진을 선택하면 자동으로 텍스트를 인식해서 아래 일기 내용에 채워줘요. <br>글씨체에 따라 인식률이 낮아질 수 있어요.<br>
                            글씨에 따라서 인식을 못하는 경우 "__" 로 수정해야할 부분이 표시돼요.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.content.id_for_label }}" class="form-label"
                               style="font-weight: 600; color: #1a1a1a; margin-bottom: 8px;">내용:</label>
                        <textarea id="content" class="form-control" rows=12
                                  style="border-radius: 16px;color: #1a1a1a;padding: 15px;font-size: 1rem;border: 1px solid #a7aaae;min-height: 250px;"
                                  placeholder="{{ topic_suggestion | default:'오늘 하루를 돌아보며 느낀 점을 자유롭게 적어보세요.'}}
손글씨 일기의 경우 파일 첨부를 이용해 주세요.">{{ form.content.value | default_if_none:'' }}</textarea>

                    </div>
                    <!-- 모델 최초 예측값 저장 숨김 필드 -->
                    {{ form.contents_predicted }}
                    <div class="mb-3">
                        <label for="mood" class="form-label"
                               style="font-weight: 600; color: #1a1a1a; margin-bottom: 8px;">{{ form.mood_self_report.label_tag }}</label>
                        {{ form.mood_self_report }}
                    </div>
                    <div class="d-flex gap-2" style="margin-top: 30px;">
                        <a href="{% url 'diary:list' %}" class="btn btn-outline-secondary" style="
                                border-radius: 25px;
                                font-weight: bolder;
                                padding: 10px 20px;
                                border-color: #1a8a9a;
                                color: #1a8a9a;
                            ">목록</a>
                        <button type="submit" class="btn btn-primary" style="
                                border-radius: 25px;
                                font-weight: bold;
                                padding: 10px 20px;
                                background-color: #1a8a9a;
                                border-color: #1a8a9a;
                                font-size: 1.05rem;
                            ">저장하고 상담 시작
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 우: 상담 패널 (새 일기 저장 전에는 비활성 안내) -->
    <div class="col-lg-5">
        <div class="card border-0 shadow-sm" style="
                border-radius: 16px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1) !important;
                background-color: #fafaf8;
                min-height: 520px;
                display: flex;
                align-items: center;
                justify-content: center;
                text-align: center;
            ">
            <div class="card-body">
                <h2 class="h6 mb-2" style="
                        font-weight: 700;
                        color: #1a8a9a;
                        font-size: 1.25rem;
                        margin-bottom: 10px !important;
                    ">Aiary Chatbot</h2>
                <p class="text-muted small mb-0" style="
                        color: #666666 !important;
                        font-size: 0.95rem;
                        line-height: 1.5;
                        padding: 10px 20px;
                        border: 1px dashed #ced4da;
                        border-radius: 16px;
                    ">
                    일기를 저장하면 AI가 내용을 분석하고,<br>
                    심층적인 상담을 시작할 수 있습니다.
                </p>
            </div>
        </div>
    </div>
</div>
<script>
(function(){
  const imageInput = document.getElementById("id_image");
  const contentArea = document.getElementById("content");  // id
  const predictedInput = document.getElementById("id_contents_predicted"); // hidden field
  const csrfTokenInput = document.querySelector('[name=csrfmiddlewaretoken]');

  if (!imageInput || !contentArea || !csrfTokenInput) {
    console.log("error");
    // console.log(imageInput);
    // console.log(contentArea);
    return;
  }

  const originalPlaceholder = contentArea.placeholder || "";
  let lastUserText = contentArea.value;
  let pollTimer = null;

  function stopPolling() {
    if (pollTimer) {
      clearInterval(pollTimer);
      pollTimer = null;
    }
  }

  function pollOcrResult(taskId) {
    pollTimer = setInterval(function(){
      fetch("{% url 'api:ocr_result' %}?task_id=" + encodeURIComponent(taskId), {
        method: "GET",
        headers: {
          "X-Requested-With": "XMLHttpRequest"
        }
      })
      .then(resp => resp.json())
      .then(data => {
        if (data.status === "pending" || data.status === "STARTED") {
          // 아직 처리 중
          return;
        }
        stopPolling();

        if (data.status === "success") {
          const text = data.text || "";
          contentArea.disabled = false;
          contentArea.value = text;
          if (predictedInput) {
            predictedInput.value = text;
          }
        } else {
          alert(data.message || "OCR 분석 중 오류가 발생했습니다.");
          contentArea.disabled = false;
          contentArea.placeholder = originalPlaceholder
          contentArea.value = lastUserText;
        }
      })
      .catch(err => {
        console.error(err);
        stopPolling();
        alert("네트워크 오류로 인해 OCR 분석에 실패했습니다.");
        contentArea.disabled = false;
        contentArea.placeholder = originalPlaceholder
        contentArea.value = lastUserText;
      })
    }, 3000); // 3초마다 폴링
  }

  imageInput.addEventListener("change", function(){
    const file = imageInput.files[0];
    if (!file) return;

    lastUserText = contentArea.value;
    contentArea.value = "";
    contentArea.placeholder = "분석중입니다...\n작업은 최대 3분정도 소요될 수 있습니다.";
    contentArea.disabled = true;

    const formData = new FormData();
    formData.append("image", file);

    fetch("{% url 'api:ocr_start' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": csrfTokenInput.value
      },
      body: formData
    })
    .then(resp => resp.json())
    .then(data => {
      if (!data.task_id) {
        throw new Error("no task_id");
      }
      // task_id 로 결과 폴링 시작
      pollOcrResult(data.task_id);
    })
    .catch(err => {
      console.error(err);
      contentArea.disabled = false;
      contentArea.placeholder = originalPlaceholder;
      contentArea.value = lastUserText;
      alert("OCR 요청 중 오류가 발생했습니다.");
    });
  });
})();
</script>
{% endblock %}
